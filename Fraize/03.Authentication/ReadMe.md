# Vulnerabilities in multi-factor authentication

- Many websites rely exclusively on single-factor authentication using a password to authenticate users, however, some require users to prove their identity using multiple authentication factors.
- It is increasingly common to see both mandatory and optional two-factor authentication **(2FA)** based on **something you know** and **something you have**.
- This requires users to enter both a traditional password and a temporary verification code from an out-of-band physical device in their possession.
- 2FA is demonstrably more secure than single-factor authentication but is only as secure as its implementation.
- Poorly implemented two-factor authentication can be beaten or bypassed entirely just as single-factor authentication can.
- Verifying the same factor in two different ways is not true two-factor authentication.
- Email-based 2FA is an example, although the user has to provide a password and a verification code, accessing the code only relies on them knowing the login credentials for their email account, therefore the knowledge authentication factor is simply being verified twice.

### Two-factor authentication tokens
- Verification codes are usually read by the user from a physical device.
- High-security websites provide users with a dedicated device for this purpose, such as the RSA token or keypad device that you might use to access your online banking or work laptop.
- The dedicated devices also have the advantage of generating the verification code directly. Dedicated mobile apps can be used such as [Google Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en&gl=US) app.
- Some of the websites send verification codes as text messages but is open to abuse. ie

> 1. The code is being transmitted via SMS rather than being generated by the device itself creating potential for the code to be intercepted.
> 2. There is also risk of SIM swapping, whereby an attacker fraudulently obtains a SIM card with the victim's phone number hence the attacker would then receive all SMS messages sent to the victim, including the one containing their verification code.

### Bypassing two-factor authentication
- The implementation of two-factor authentication is flawed to the point where it can be bypassed entirely.
- If user is first prompted to enter a password, and then prompted to enter a verification code on a separate page, the user is effectively in a **logged-in** state before they have entered the verification code.
- Test if you can directly skip to **logged-in only** pages after completing the 1st authentication step.
- Occasionally, a website doesn't check whether or not you completed the second step before loading the page.

### Flawed two-factor verification logic
> Flawed logic in two-factor authentication means that after a user has completed the initial login step, the website doesn't adequately verify that the same user is completing the second step.
- Eg: user logs in with their normal credentials in the first step as below:
```
POST /login-steps/first HTTP/1.1
Host: vulnerable-website.com
...
username=alsphat&password=qwerty123
```
- They are then assigned a cookie that relates to their account, before being taken to the second step of the login process:
```
HTTP/1.1 200 OK
Set-Cookie: account=alsphat

GET /login-steps/second HTTP/1.1
Cookie: account=alsphat
```
- When submitting the verification code, the request uses this cookie to determine which account the user is trying to access:
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=alsphat
...
verification-code=123456
```
- An attacker could log in using their own credentials but then change the value of the **account** cookie to any arbitrary username when submitting the verification code.
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=victim-user
...
verification-code=123456
```
- This is dangerous if the attacker is able to brute-force the verification code as it would allow them to log in to arbitrary users' account based entirely on their usernames.

### Brute-forcing 2FA verification codes
- As with passwords, websites need to take steps to prevent brute-forcing of the 2FA verification code especially because the code is often a simple 4 or 6 digit number. Without adequate brute-forcing protection, cracking such a code is trivial.
- Some websites attempt to prevent this by automatically logging a user out if they enter a certain number of incorrect verification codes.
- This is ineffective in practice because an attacker can automate this multi-step process by creating macros for Burp Intruder.

------------------------------------------------------------------
# Materials

### Referencing
   - [Multi-factor authentication](https://portswigger.net/web-security/authentication/multi-factor)
    
### Labs
   - [Lab: 2FA simple bypass](https://portswigger.net/web-security/authentication/multi-factor/lab-2fa-simple-bypass)
   - [Lab: 2FA broken logic](https://portswigger.net/web-security/authentication/multi-factor/lab-2fa-broken-logic)
   - [Lab: 2FA bypass using a brute-force attack](https://portswigger.net/web-security/authentication/multi-factor/lab-2fa-bypass-using-a-brute-force-attack)
------------------------------------------------------------------
